<!DOCTYPE html>
<html>
  <head>
	<script src="/js/jquery.js"></script>
  	<link href="/bootstrap/css/bootstrap.css" rel="stylesheet">
	<script src="/bootstrap/js/bootstrap.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100%; width:100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhcFl3Kw3amhvtaY9fzr9BiyUu6YPfqc0&sensor=false&libraries=geometry">
    </script>
    <script>
		var markers = [];
		var map;
      function initialize() {

        var mapOptions = {
          center: new google.maps.LatLng(43.074844,-89.384265),
          zoom: 14,
		  maxZoom: 18
        };
		
	var styles = [
		{ 
			featureType: "poi.business",
			elementType: "labels",
			stylers: [{ visibility: "off" }]
		}
	]
		
		
		
		
        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
		map.setOptions({styles:styles});
			
	  //Pre-Add a marker
	  var myLatlng = new google.maps.LatLng(43.076301,-89.376575);
		
	  //var marker = new google.maps.Marker({
		//  position: myLatlng,
		//  map: map,
		//  title: 'Hello World!'
	  //});
	  
		//add click listener
		google.maps.event.addListener(map, 'click', function(event) {
		addMarker(event.latLng);
	  });
}

	// Add a marker to the map and push to the array.
	function addMarker(location) {
	  clearMarkers();
	  var marker = new google.maps.Marker({
		position: location,
		map: map
	  });
	  markers.push(marker);

	}

	// Sets the map on all markers in the array.
	function setAllMap(map) {
	  for (var i = 0; i < markers.length; i++) {
		markers[i].setMap(map);
	  }
	}
	// Removes the markers from the map, but keeps them in the array.
	function clearMarkers() {
	  setAllMap(null);
	  markers = []
	}
	

	  var b2long = "";
	  var b2lat = "";
      google.maps.event.addDomListener(window, 'load', initialize);

	  $(document).ready(function() {
		//grab list of bars here and set up first one.
		var barslist = {}
		var barlist = {}
		$.ajax({
			type: "GET",
			url: "/getbarlist",
			data: barlist,
			dataType: 'json',
			async: false,
			success: function(barlist) {
				var newbar = barlist['bars'].pop()
				$('#barname').html(newbar);
				barslist = barlist
			}
		 });
		$('#submit').click(function(){
			 //1. Get name of bar and pass as json array to server
			 var barname = {"barname":$("#barname").text()};
			 //2. Get lat and long of bar for comparison
			 var bar2 = $.ajax({
				type: "GET",
				url: "/getbarlatlong",
				data: barname,
				dataType: 'json',
				async: false
			 });
		 	 bar2.success(function(data) {
				b2long = data.long;
				b2lat = data.lat;
			 });
			 // Create gmaps position object
			 var bar= new google.maps.LatLng(b2lat,b2long);
			 // Grab position of marker
			 var location = markers[0].getPosition();
			 //compare distance between marker and specified bar
			 var distance=google.maps.geometry.spherical.computeDistanceBetween(bar, location);
			 //Leaving this to remember how to log to console:
			 console.log(distance)
			 var data={"distance":distance};
			 // This creates the AJAX connection
			 $.ajax({
				 type: "POST",
				 url: "/",
				 data: data,
				 dataType: 'json',
				 success: function(data) {
					 if (parseInt(data.distance) < 100) {
						$('#distance').html("<strong>You got it!</strong>")
					 }
					 else {
						var output = "<strong>You were off by " + data.distance + " meters. Try again!</strong>"
						$('#distance').html(output);
					 }
					 //$('#distance').html(data.distance);
					 if (data.correct == "True") {
						var correctDiv = document.getElementById('correct');
						var spanTag = document.createElement('span');
						spanTag.setAttribute('class','glyphicon glyphicon-ok');
						correctDiv.appendChild(spanTag);
						if (barslist['bars'].length > 0) {
							$('#barname').html(barslist['bars'].pop());
						}
						else {
								window.location.href = "/gameover";
						}
					 }
				 }
			 });
			});
		});		
	  
	  
	  
    </script>
  </head>
  <body>
   <div id="header" class="navbar-default navbar-collapse collapse navbar-responsive-collapse">
	<div class="navbar-collapse collapse navbar-responsive-collapse">
		<div class="row">
			<strong><div class="col-md-1" id="barname"></div></strong>
			<button type="button" class="btn btn-success col-md-1" id="submit">Submit Location</button>
			<div id="correct" class="col-md-3"></div>
			<div id="distance" class="col-md-3"></div>
		</div>
	 </div>
	</div>
	<div id="map-canvas"> </div>
  </body>
</html>